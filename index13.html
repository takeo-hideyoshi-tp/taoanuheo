<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script type='text/javascript' src="./dist/React.js"></script> 
     <!-- <script type='text/javascript' src="./test/react.js"></script>
     <script type='text/javascript' src="./test/react-dom.js"></script> -->
   <script src="./lib/babel.js"></script>
    <script type='text/babel'>
class ListItem extends React.Component{
    componentDidMount(){
       var props =  this.props
       var listModel = props.listModel
       var _this = this
       setTimeout(function(){
         listModel.resolveItem(props.index, _this.domNode.offsetHeight);
       },15)
    }
    
    render(){
        return <li ref={(dom)=>{ this.domNode = dom;}}>{this.props.item}</li>
    }
}

class List extends React.Component{
     constructor(props){
         super(props)
         this.state = {
             height: 0
         }
         this.types = {}
         this.totalHeight = 0
         this.keys = {}

     }
     componentWillMount(){
       console.log('change')
    }
     resolveItem(key, height) {
          if(this.keys[key] == void 666){
            this.keys[key] = true
            this.totalHeight += height;
            console.log(this.totalHeight)
            this.emitChange();
          }
      }
      addEvent(type, fn){
        this.types[type] =  this.types[type] || []
        var list =  this.types[type] 
        list.push(fn)
      }
      emitEvent(type){
          var list = this.types[type]
          if(list){
              var args = [].slice.call(arguments,1)
              list.forEach(function(fn){
                 fn.call(this, args)
              }, this)
          }
      }
      componentWillMount(){
          this.addEvent('change', function (totalHeight) {
             this.setState({ height: totalHeight });
          });
      }
      componentDidMount(){
          console.log('list did mount')
      }
      emitChange(){
         this.emitEvent("change",this.totalHeight)
      }
      render(){
          return <div style={{height: this.state.height}}><ul>{["xxxx",'1111',<p>333<br/>333</p>,"sdfdsf\ndfd\n34343"].map((el, index)=>{
            return <ListItem listModel={this} item={el} key={index} index={index}/>
          })}</ul></div>
      }
}
      
       window.onload = function(){

            ReactDOM.render(
                <List />,
                document.getElementById('content')
            );
       }
       </script>
</head>

<body>

    <div>这个默认会被清掉</div>
    <div id='content'></div>


</body>

</html>