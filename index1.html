<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="ie=edge" />
        <title>Document</title>
    </head>

    <body>
      <form>
          <menu> 
              <command onclick="alert('Hello World')"> Click Me!</command> 
              </menu>
      </form>
        <script>
 class Node {
    constructor(data) {
      this.data = data;
      this.right = null;
      this.left = null;
      this.fix = ~~(Math.random() + "").slice(2, 7);
      this.size = 1;
      this.count = 1;
    }
    maintain() {
      var leftSize = this.left ? this.left.size : 0;
      var rightSize = this.right ? this.right.size : 0;
      this.size = leftSize + rightSize + this.count;
    }
  }
  class Treap {
      find(value) {
        var node = this.root;
        while (node) {
          var diff = value - node.data;
          if (value === 0) {
            return node
          } else if (value > 0) {
            node = node.right;
          } else {
            node = node.left;
          }
        }
        return null;
      }
      insert(value) {
        this.root = this._insert(this.root, value)
        getOrder(this)
      }
      _insert(node, value) {
        if (!node) {
          return new Node(value)
        }
        if (node.data == value) {
          node.count++;
          node.maintain()
          return node;
        } else if (node.data > value) {
          node.left = this._insert(node.left, value);
          if (node.left.fix < node.fix) {
            node = this.rotateRight(node)
          }
        } else {
          node.right = this._insert(node.right, value);
          if (node.right.fix < node.fix) {
            node = this.rotateLeft(node)
          }
        }
        node.maintain()
        return node;
      }
      rotateLeft(node) {
        var top = node.right; //会上浮的子节点
        // top.size = node.size;//外面会处理，这里就不重复
        node.right = top.left;//过继
        node.maintain()//维护size
        top.left = node;//旋转
        return top;
      }

      rotateRight(node) {
        var top = node.left;//会上浮的子节点
        // top.size = node.size;
        node.left = top.right;//过继
        node.maintain();//维护size
        top.right = node;//旋转
        return top;
      }


      inOrder(cb) {
        function recursion(node) {
          if (node) {
            recursion(node.left)
            cb(node)
            recursion(node.right)
          }
        }
        recursion(this.root)
      }
      preOrder(cb) {
        function recursion(node) {
          if (node) {
            cb(node)
            recursion(node.left)
            recursion(node.right)
          }
        }
        recursion(this.root)
      }
      postOrder(cb) {
        function recursion(node) {
          if (node) {
            recursion(node.left)
            recursion(node.right)
            cb(node)
          }
        }
        recursion(this.root)
      }
      getSize(node) {
        return node ? node.size : 0
      }
      getKth(k) {
        var node = this.root
        while (node) {
          if (k <= this.getSize(node.left)) {
            node = node.left
          } else if (k > this.getSize(node.left) + node.count) {
            k -= (this.getSize(node.left) + node.count)
            node = node.right
          } else {
            return node.data
          }
        }
        return null
      }
      getRank(value) {
        return this.getRankInner(this.root, value)
      }

      getRankInner(node, value) {
        if (!node) {
          return 0;
        } else if (node.data == value) {
          return this.getSize(node.left) + 1
        } else if (node.data > value) {
          return this.getRankInner(node.left, value);
        } else {
          return this.getRankInner(node.right, value) + this.getSize(node.left) + node.count
        }
      }

      remove(value) {
        var parents = [], node = this.root;
        while (node) {
          var diff = value - node.data;
          if (diff === 0) {
            break
          }
          parents.push(node)
          if (diff > 0) {
            node = node.right;
          } else {
            node = node.left;
          }
        }
        if (node) { //找到要删除的节点
          console.log("找到要删除的节点", node)
          if (node.count > 1) {
            node.count--
          } else {
            var parent = parents[parents.length - 1], newParent
            while (node.left && node.right) {
              var dir = Object(parent).left == node ? 'left' : 'right'
              if (node.left.fix < node.right.fix) {
                //left上位
                newParent = this.rotateRight(node)
                console.log('右旋', newParent.data)
              } else {
                newParent = this.rotateLeft(node)
                console.log('左旋', newParent.data)
                //right上位
              }
              if (!parent) {
                this.root = newParent
              } else {
                parent[dir] = newParent;
              }
              parent = newParent;
              parents.push(parent)
            }

            var dir = Object(parent).left == node ? 'left' : 'right'
            parent[dir] = node.left || node.right || null
          }
          console.log("找到要维护的父节点", parents.map(function (el) {
            return el.data
          }))
          while (parents.length) {
            var a = parents.pop()
            a.maintain()
          }
          return true
        }
        return false
      }
    }
    var array = [7, 11, 13, 8, 44, 78, 15, 9, 77, 1, 2]  //[11,7,14,3,9,18,16,15]
    var t = new Treap(2);
    array.forEach(function (el) {
      t.insert(el)
    })
    function getOrder(t) {
      var array = []
      t.inOrder(function (node) {
        array.push(node.data)
      })
      console.log(array + "")
    }
    var a = t.getRank(44)
    console.log('t.getRank(44)', a);
    var b = t.getKth(a)
    console.log(`t.getKth(${a})`, b);

    t.remove(11)
    t.remove(3)
    console.log("移除11,3后")
    t.insert(23)

        </script>
        
        <div id="root"></div>
    </body>
</html>

