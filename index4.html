<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <style>
        .aaa {
            width: 200px;
            height: 200px;
            background: red;
        }
       .bbb {
            width: 200px;
            height: 200px;
            background: lawngreen;
        }
    </style>
    </style>
     <script type='text/javascript' src="./dist/polyfill.js"></script>
     <script type='text/javascript' src="./dist/React.js"></script>
     <script type='text/javascript' src="./dist/app.js"></script>
      <script src="./test/babel.js"></script>
  <script type='text/babel'>
  window.onload = function(){
    var eventSystem = React.eventSystem

 var events = eventSystem.isTouch ? ['touchstart','touchmove','touchend','touchcancel']: 
   ['mousedown','mousemove','mouseup']
events.forEach(function(type){
    eventSystem.addEvent(window, type, function(e){
        e.__type__ = 'touchtap'
        eventSystem.dispatchEvent(e)
    })
})

function isEndish(topLevelType) {
  return topLevelType === 'mouseup' || topLevelType === 'touchend' || topLevelType === 'touchcancel';
}

function isMoveish(topLevelType) {
  return topLevelType === 'mousemove' || topLevelType === 'touchmove';
}
function isStartish(topLevelType) {
  return topLevelType === 'mousedown' || topLevelType === 'touchstart';
}

var tapMoveThreshold = 10;
var ignoreMouseThreshold = 750;
var startCoords = {x: null, y: null};
var lastTouchEvent = null;

var Axis = {
  x: {page: 'pageX', client: 'clientX', envScroll: 'currentPageScrollLeft'},
  y: {page: 'pageY', client: 'clientY', envScroll: 'currentPageScrollTop'}
};
// fbjs/lib/TouchEventUtils
var TouchEventUtils = {
	  /**
	   * Utility function for common case of extracting out the primary touch from a
	   * touch event.
	   * - `touchEnd` events usually do not have the `touches` property.
	   *   http://stackoverflow.com/questions/3666929/
	   *   mobile-sarai-touchend-event-not-firing-when-last-touch-is-removed
	   *
	   * @param {Event} nativeEvent Native event that may or may not be a touch.
	   * @return {TouchesObject?} an object with pageX and pageY or null.
	   */
	  extractSingleTouch: function(nativeEvent) {
	    var touches = nativeEvent.touches|| [];
	    var changedTouches = nativeEvent.changedTouches|| [];

	    return  changedTouches[0] || touches[0] ||  nativeEvent;
	  }
	};
function getAxisCoordOfEvent(axis, nativeEvent) {
  var singleTouch = TouchEventUtils.extractSingleTouch(nativeEvent);
  if (singleTouch) {
    return singleTouch[axis.page];
  }
  return nativeEvent[axis.page] 
}

function getDistance(coords, nativeEvent) {
  var pageX = getAxisCoordOfEvent(Axis.x, nativeEvent);
  var pageY = getAxisCoordOfEvent(Axis.y, nativeEvent);
  return Math.pow(
    Math.pow(pageX - coords.x, 2) + Math.pow(pageY - coords.y, 2),
    0.5
  );
}
function shouldRejectClick(){}
eventSystem.eventLowerCache['touchtap'] = 'touchTap'
eventSystem.eventPropHooks.touchtap = function(event){
  var type = event.type
   if (!isStartish(type) && !isEndish(type)) {
        return false
      }

      if (eventSystem.isTouch) {
        lastTouchEvent = Date.now();
      } else {
        if (shouldRejectClick(lastTouchEvent, Date.now())) {
          return false
        }
      }
      var distance = getDistance(startCoords, event);
      var returnFalse = true
      if (isEndish(type) && distance < tapMoveThreshold) {
        event.type = 'touchTap'
        console.log('---touchTaptouchTaptouchTap-----',event.type)
      }else{
        returnFalse = false
      }
      if (isStartish(type)) {
        startCoords.x = getAxisCoordOfEvent(Axis.x, event);
        startCoords.y = getAxisCoordOfEvent(Axis.y, event);
      } else if (isEndish(type)) {
        startCoords.x = 0;
        startCoords.y = 0;
      }
    
      return returnFalse && event

}
    class App extends React.Component {
      constructor(props) {
        super(props);
        this.state = {
          aaa: 1111
        };
      }
      componentWillMount() {
        this.state = {
            aaa: 333
          }
        this.forceUpdate( function(){
          
          console.log('forceUpdate')
        });
      }
      render() {
        return <p onTouchTap={(e)=>{ console.log('用户触发',e.type)}}>{this.state.aaa}</p>;
      }
    }

    var s = ReactDOM.render(<App />, document.getElementById('example'));
  }
  </script>

</head>

<body>

    <div>开发者工具</div>
    <div id='example'></div>

<div id='aaa'></div>

</body>

</html>